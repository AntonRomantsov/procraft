<?xml version="1.0" encoding="UTF-8"?>
<modification>
	<name>NeoSeo Product Video</name>
	<version>2.0</version>
	<code>neoseo_product_video</code>
	<author>NeoSeo</author>
	<link>https://neoseo.com.ua</link>

<file path="admin/controller/catalog/product.php">
	<operation>
		<search><![CDATA[$data['text_form'] = !isset($this->request->get['product_id']) ? $this->language->get('text_add') : $this->language->get('text_edit');]]></search>
		<add position="after"><![CDATA[
		/* NeoSeo Product Video - begin */
		$data['entry_video_url'] = $this->language->get('entry_video_url');
		$data['neoseo_product_video_status'] = $this->config->get('neoseo_product_video_status');
		/* NeoSeo Product Video - end */
		]]></add>
	</operation>
	<operation>
		<search><![CDATA[$data['product_images'][]]]></search>
		<add position="before"><![CDATA[
			/* NeoSeo Product Video - begin */
			if(isset($product_image['product_image_id'])){
				$product_image_id = $product_image['product_image_id'];
				$input = 1;
			}else{
				$product_image_id = $key;
				$input = 0;
				foreach($product_image['video_data'] as $store_id => $video_urls){
					foreach($video_urls as $lang => $url){
						$video[$key][$store_id][$lang] = $url;
					}
				}
			}
			/* NeoSeo Product Video - end */
		]]></add>
	</operation>
	<operation>
		<search><![CDATA[=> $this->model_tool_image->resize($thumb, 100, 100),]]></search>
		<add position="after"><![CDATA[
				/* NeoSeo Product Video - begin */
				'image_id'      => (isset($product_image['product_image_id']))? $product_image['product_image_id'] : $key,
				'input'         => $input,
				'video_data'    =>isset($product_image['product_image_id']) && $data['neoseo_product_video_status'] ? $this->model_tool_neoseo_product_video->getVideoUrls($product_image['product_image_id']) : $video,
				/* NeoSeo Product Video - end */
		]]></add>
	</operation>
	<operation>
		<search><![CDATA[foreach ($product_images as $product_image) {]]></search>
		<add position="before"><![CDATA[
		/* NeoSeo Product Video - begin */
		if($data['neoseo_product_video_status'] == 1){
			$this->load->model('tool/neoseo_product_video');
		}
		/* NeoSeo Product Video - end */
		]]></add>
	</operation>
	<operation>
		<search><![CDATA[$stores = $this->model_setting_store->getStores();]]></search>
		<add position="after"><![CDATA[
		/* NeoSeo Product Video - begin */
		$stores_module = array();
		$stores_module[0] = array(
		"name" => $this->config->get('config_name') . $this->language->get('text_default'),
		"url" => rtrim($this->config->get('config_secure') ? HTTPS_CATALOG : HTTP_CATALOG, "/") . "/");
		foreach ($this->model_setting_store->getStores() as $store) {
				$stores_module[$store['store_id']] = array(
				"name" => $store['name'],
				"url" => rtrim($store["url"], "/") . "/");
		}
		$data['stores_video'] = $stores_module;
		/* NeoSeo Product Video - end */
		]]></add>
	</operation>
	<operation>
		<search><![CDATA[foreach ($product_images as $product_image) {]]></search>
		<add position="replace"><![CDATA[
		/* NeoSeo Product Video - begin */
		foreach ($product_images as $key => $product_image) {
			$video = array();
		/* NeoSeo Product Video - end */
		]]></add>
	</operation>
	<operation>
		<search><![CDATA[$this->load->model('catalog/download');]]></search>
		<add position="before"><![CDATA[
		/* NeoSeo Product Video - begin */
		$data['product_images'] = array_map("unserialize", array_unique(array_map("serialize", $data['product_images'])));
		/* NeoSeo Product Video - end */
		]]></add>
	</operation>
</file>

<file path="admin/language/*/catalog/product.php">
	<operation>
		<search ><![CDATA[<?php]]></search>
		<add position="after" ><![CDATA[
		/* NeoSeo Product Video - begin */
		$_['entry_video_url'] = 'Введите ссылку на видео';
		/* NeoSeo Product Video - end */
		]]></add>
	</operation>
</file>

<file path="admin/model/catalog/product.php">
	<operation>
		<search><![CDATA[if (isset($data['product_image'])) {]]></search>
		<add position="after"><![CDATA[
		/* NeoSeo Product Video - begin */
		if($this->config->get('neoseo_product_video_status')== 1) {
			$this->load->model('tool/neoseo_product_video');
		}
		/* NeoSeo Product Video - end*/
		]]></add>
	</operation>
	<operation>
		<search><![CDATA[$this->db->query("DELETE FROM " . DB_PREFIX . "product_image WHERE product_id = '" . (int)$product_id . "'");]]></search>
		<add position="before"><![CDATA[
		/* NeoSeo Product Video - begin */
		if ($this->config->get('neoseo_product_video_status')== 1) {
			$this->db->query("DELETE FROM " . DB_PREFIX . "product_video WHERE product_id = '" . (int)$product_id . "'");
		}
		/* NeoSeo Product Video - end */
		]]></add>
	</operation>
	<operation>
		<search><![CDATA[$this->db->query("INSERT INTO " . DB_PREFIX . "product_image SET product_id = '" . (int)$product_id . "', image = '" . $this->db->escape($product_image['image']) . "', sort_order = '" . (int)$product_image['sort_order'] . "'");
			]]></search>
		<add position="replace"><![CDATA[
				/* NeoSeo Product Video - begin */
				$this->db->query("INSERT INTO " . DB_PREFIX . "product_image SET product_id = '" . (int)$product_id . "', image = '" .  $this->db->escape($product_image['image']) . "', sort_order = '" . (int)$product_image['sort_order'] . "'");
				if ($this->config->get('neoseo_product_video_status')== 1) {
					$last_id = $this->db->getLastId();
					if(isset($product_image['video_data'])) {
						foreach ($product_image['video_data'] as $store_id=> $video_language) {
							foreach ($video_language as $language_id => $video_url) {
								if ($video_url && $video_url != '') {
								$this->model_tool_neoseo_product_video->insertUrl($product_id,$last_id,$product_image['image'],$product_image['sort_order'],$video_url,$language_id,$store_id);
								}
							}
						}
					}
				}
				/* NeoSeo Product Video - end*/
		]]></add>
	</operation>
	<operation>
		<search><![CDATA[$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "product_image WHERE product_id = '" . (int)$product_id . "' ORDER BY sort_order ASC");]]></search>
		<add position="replace"><![CDATA[
		/* NeoSeo Product Video - begin */
		if ($this->config->get('neoseo_product_video_status')== 1) {
			$query = $this->db->query("SELECT pi.*, pv.video_url , pv.language_id, pv.store_id FROM " . DB_PREFIX . "product_image pi LEFT JOIN " . DB_PREFIX . "product_video pv ON (pv.product_image_id = pi.product_image_id AND pv.store_id = '" . (int)$this->config->get('config_store_id') . "' ) WHERE pi.product_id = '" . (int)$product_id . "' ORDER BY sort_order ASC");
		} else {
			$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "product_image WHERE product_id = '" . (int)$product_id . "' ORDER BY sort_order ASC");
		}
		/* NeoSeo Product Video - end*/
		]]></add>
	</operation>
</file>
<file path="admin/view/template/catalog/product_form.twig">
	<operation>
		<search><![CDATA[<td class="text-left"><button type="button" onclick="addImage();" data-toggle="tooltip" title="{{ button_image_add }}" class="btn btn-primary"><i class="fa fa-plus-circle"></i></button></td>]]></search>
		<add position="replace" offset="-1"><![CDATA[
    <!-- NeoSeo Product Video - begin -->
    {% if neoseo_product_video_status == 1 %}
    <td colspan="3"></td>
    <td class="text-left"><button type="button" onclick="addImage();" data-toggle="tooltip" title="<?php echo $button_image_add; ?>" class="btn btn-primary"><i class="fa fa-plus-circle"></i></button></td>
    {% endif %}
    <!-- NeoSeo Product Video - end -->
	]]></add>
	</operation>
	<operation>
		<search><![CDATA[function addImage()]]></search>
		<add position="after"><![CDATA[
    <!-- NeoSeo Product Video - begin -->
   {% if neoseo_product_video_status == 1 %}
        html_gen = '';
        {% for store_id,store_data in stores_video %}
            html_gen += '<table width="100%" >';
            html_gen += '<tr>';
            html_gen += '<p class="col-xs-3 text-left" >{{ store_data['name'] }}</p>';
            html_gen += '<td class="col-xs-3 ">{{ entry_video_url }}</td>';
            html_gen += '<td class="col-xs-9">';				  
            {% for key,language in languages %}
                html_gen += '<div class="input-group ">';
                html_gen += '<span class="input-group-addon"><img src="language/{{ language['code'] }}/{{ language["code"] }}.png" title="{{ language["name"] }}" /></span>';
                html_gen +='<input class="form-control" name="product_image['+image_row+'][video_data][{{ store_id }}][{{ language["language_id"] }}]" value="" />';
                html_gen +='</div>';
             {% endfor %}
             html_gen += '</td></tr></table>';
       {% endfor %}
    {% endif %}
    <!-- NeoSeo Product Video - end -->
		]]></add>
	</operation>
	<operation>
		<search><![CDATA[html += '  <td class="text-left"><a href="" id="thumb-image' + image_row + '"data-toggle="image"]]></search>
		<add position="after"><![CDATA[
    <!-- NeoSeo Product Video - begin -->
   {% if neoseo_product_video_status == 1 %}
        html += '  <td class="text-right">' +
        html_gen +'</td>';
    {% endif %}
    <!-- NeoSeo Product Video - end -->
		]]></add>
	</operation>
	<operation>
		<search><![CDATA[$('#images tbody').append(html);]]></search>
		<add position="replace"><![CDATA[
    <!-- NeoSeo Product Video - begin -->
    $('#images').append(html);
    <!-- NeoSeo Product Video - end -->
		]]></add>
	</operation>
	<operation>
		<search><![CDATA[<td class="text-left">{{ entry_additional_image }}</td>]]></search>
		<add position="after"><![CDATA[
                      <!-- NeoSeo Product Video - begin -->
                       {% if neoseo_product_video_status == 1 %}
                      <td class="text-left">{{ entry_video_url }}</td>
                      {% endif %}
                      <!-- NeoSeo Product Video - end -->]]></add>
	</operation>
	<operation>
		<search><![CDATA[<td class="text-right"><input type="text" name="product_image[{{ image_row }}][sort_order]"]]></search>
		<add position="before"><![CDATA[
    <!-- NeoSeo Product Video - begin -->
    {% if neoseo_product_video_status == 1 %}
        <td class="text-right">
       {% for store_id,store_data in stores_video %}
            <table width="100%" >
            <tr>
            <p class="col-xs-3 text-left" >{{ store_data['name'] }}</p>
            <td class="col-xs-3 ">{{ entry_video_url }}</td>
            <td class="col-xs-9">
            {% for key,language in languages %}
                <div class="input-group ">
                <span class="input-group-addon"><img src="language/{{ language['code'] }}/{{ language['code'] }}.png" title="{{ language['name'] }}" /></span>
                 {% if product_image.input == 1 %}
                    <input class="form-control" name="product_image[{{ image_row }}][video_data][{{ store_id }}][{{ language['language_id'] }}]" value="{{ product_image['video_data'][product_image['image_id']][store_id][language['language_id']] is defined ? product_image['video_data'][product_image['image_id']][store_id][language['language_id']] : '' }}" />
                 {% else %}
                    <input class="form-control" name="product_image[{{ image_row }}][video_data][{{ store_id }}][{{language['language_id'] }}]" value="{{ product_image['video_data'][product_image['image_id']][store_id][language['language_id']] }}" />
               {% endif %}
                </div>
            {% endfor %}
            </td>
            </tr>
            </table>
		{% endfor %}
        </td>
    {% endif %}
    <!-- NeoSeo Product Video - end -->
		]]></add>
	</operation>
</file>
<file path="catalog/controller/product/product.php">
	<operation>
		<search><![CDATA[$data['description'] = html_entity_decode($product_info['description'], ENT_QUOTES, 'UTF-8');]]></search>
		<add position="after"><![CDATA[
			/* NeoSeo Product Video - begin */
			$data['neoseo_product_video_status'] = $this->config->get('neoseo_product_video_status');
			/* NeoSeo Product Video - end */
		]]></add>
	</operation>
	<operation>
		<search><![CDATA[$this->model_tool_image->resize($result['image'], $this->config->get('theme_' . $this->config->get('config_theme') . '_image_popup_width'), $this->config->get('theme_' . $this->config->get('config_theme') . '_image_popup_height')),]]></search>
		<add position="after"><![CDATA[
					/* NeoSeo Product Video - begin */
					'video_url' => isset($result['video_url']) && $result['video_url'] ? preg_replace('/\s*[a-zA-Z\/\/:\.]*youtube.com\/watch\?v=([a-zA-Z0-9\-_]+)([a-zA-Z0-9\/\*\-\_\?\&\;\%\=\.]*)/i', '//www.youtube.com/embed/$1', $result['video_url']) : '',
					/* NeoSeo Product Video - end */
		]]></add>
	</operation>
</file>
<file path="catalog/model/catalog/product.php">
	<operation>
		<search><![CDATA[$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "product_image WHERE product_id = '" . (int)$product_id . "' ORDER BY sort_order ASC");]]></search>
		<add position="replace"><![CDATA[
		/* NeoSeo Product Video - begin */
		if ($this->config->get('neoseo_product_video_status')== 1) {
			$query = $this->db->query("SELECT pi.*, pv.video_url , pv.language_id, pv.store_id FROM " . DB_PREFIX . "product_image pi LEFT JOIN " . DB_PREFIX . "product_video pv ON (pv.product_image_id = pi.product_image_id AND pv.store_id = '" . (int)$this->config->get('config_store_id') . "' AND pv.language_id = '" . (int)$this->config->get('config_language_id') . "') WHERE pi.product_id = '" . (int)$product_id . "' ORDER BY sort_order ASC");
		} else {
			$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "product_image WHERE product_id = '" . (int)$product_id . "' ORDER BY sort_order ASC");
		}
		/* NeoSeo Product Video - end */
		]]></add>
	</operation>
</file>



</modification>